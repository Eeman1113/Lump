<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Digital Writer's Room</title>
    <link rel="icon" type="image/png" href="./bag.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <style>
        :root {
            --bg-color: #f9fafb; /* gray-50 */
            --editor-bg: #ffffff;
            --sidebar-bg: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
            --text-primary: #111827; /* gray-900 */
            --text-secondary: #4b5563; /* gray-600 */
            --text-muted: #9ca3af; /* gray-400 */
            --accent-color: #8b5cf6; /* violet-500 */
            --accent-color-light: #ede9fe; /* violet-100 */
            --accent-text-dark: #6d28d9; /* violet-700 */
            --suggestion-bg: #fef9c3; /* yellow-100 */
            --suggestion-border: #f59e0b; /* amber-500 */
            --danger-color: #ef4444; /* red-500 */
            --font-serif: 'Instrument Serif', serif;
            --font-sans: 'Noto Sans', sans-serif;
        }
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow: hidden; /* Prevent body scroll */
        }
        
        /* Custom Selection Highlight Color */
        ::selection { background-color: var(--accent-color-light); color: var(--text-primary); }
        ::-moz-selection { background-color: var(--accent-color-light); color: var(--text-primary); }

        /* Custom Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 10px; border: 2px solid var(--bg-color); }
        ::-webkit-scrollbar-thumb:hover { background-color: #9ca3af; }

        /* Main Layout */
        .main-container { display: grid; grid-template-columns: 1fr; height: 100vh; }
        @media (min-width: 1024px) { .main-container { grid-template-columns: minmax(0, 2fr) minmax(380px, 1fr); } }
        
        /* Editor Panel */
        #editor-panel { display: flex; flex-direction: column; height: 100vh; background-color: var(--editor-bg); }
        #editor-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 2rem; border-bottom: 1px solid var(--border-color); }
        #editor-wrapper { flex-grow: 1; position: relative; overflow-y: auto; }
        #editor-column { max-width: 740px; margin: 0 auto; padding: 2rem; }
        #doc-title { 
            width: 100%; 
            font-size: 2.75rem; 
            font-weight: 700; 
            border: none; 
            padding: 0; 
            margin-bottom: 1.5rem; 
            background: transparent;
            font-family: var(--font-serif);
        }
        #doc-title:focus { outline: none; }
        #doc-title::placeholder {
            color: #d1d5db; /* gray-300 */
        }
        .ql-toolbar { display: none !important; }
        .ql-container { border: none !important; }
        .ql-editor { 
            min-height: 80vh; 
            font-family: var(--font-serif);
            font-size: 1.2rem; 
            line-height: 1.75; 
            color: var(--text-primary); 
            padding: 0 !important; 
        }
        .ql-editor.ql-blank::before { 
            color: var(--text-muted); 
            font-style: normal; 
            left: 0 !important;
            font-family: var(--font-serif);
            font-size: 1.2rem;
        }
        
        /* AI Suggestion Styling */
        .ai-suggestion { background-color: var(--suggestion-bg); border-bottom: 2px dotted var(--suggestion-border); cursor: pointer; }
        #suggestion-toolbar { position: absolute; background-color: var(--text-primary); color: white; padding: 0.5rem 0.75rem; border-radius: 0.5rem; display: flex; align-items: center; gap: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; transition: opacity 0.2s, transform 0.2s; }
        #suggestion-toolbar button { background: transparent; border: none; color: white; font-weight: 500; font-size: 0.875rem; padding: 0.25rem; border-radius: 0.25rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem; }
        #suggestion-toolbar button:hover { background-color: rgba(255,255,255,0.2); }

        /* AI Side Panel */
        #ai-panel { display: flex; flex-direction: column; height: 100vh; background-color: var(--sidebar-bg); border-left: 1px solid var(--border-color); padding: 1.5rem; }
        #ai-panel h2 {
            font-family: var(--font-serif);
            font-weight: 700;
            font-size: 1.5rem;
        }
        #ai-output-container { flex-grow: 1; overflow-y: auto; padding-bottom: 1rem; }
        #chat-form-wrapper { position: relative; margin-top: 1rem; }
        #chat-input { width: 100%; padding: 0.75rem 3rem 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 0.75rem; background-color: var(--editor-bg); box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s ease-in-out; }
        #chat-input:focus { outline: none; box-shadow: 0 0 0 2px var(--accent-color); }
        #send-btn { position: absolute; top: 50%; right: 0.5rem; transform: translateY(-50%); background-color: var(--accent-color); color: white; border: none; cursor: pointer; padding: 0.375rem; border-radius: 0.5rem; transition: background-color 0.2s; }
        #send-btn:hover { background-color: #7c3aed; }
        #send-btn:disabled { background-color: #c4b5fd; cursor: not-allowed; }

        /* Agent Tools */
        #tools-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
        .tool-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; padding: 1rem 0.5rem; border-radius: 0.75rem; font-weight: 500; font-size: 0.875rem; text-align: center; border: 1px solid var(--border-color); background-color: var(--bg-color); transition: all 0.2s; cursor: pointer; }
        .tool-btn:hover, .tool-btn.active { background-color: var(--accent-color-light); border-color: var(--accent-color); color: var(--accent-text-dark); }
        .tool-btn svg { width: 24px; height: 24px; }

        /* AI Output Card */
        .ai-output-card { margin-bottom: 1rem; padding: 1rem; background-color: var(--editor-bg); border-radius: 0.75rem; border: 1px solid var(--border-color); animation: fadeIn 0.5s ease-out; transition: border-color 0.3s, box-shadow 0.3s; }
        .ai-output-card.is-processing { border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-color-light); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .agent-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .agent-name { font-weight: 600; font-size: 0.875rem; color: var(--accent-color); display: flex; align-items: center; gap: 0.5rem; }
        .output-actions { display: flex; align-items: center; gap: 0.25rem; }
        .output-actions button { padding: 0.25rem; color: var(--text-secondary); border-radius: 0.25rem; }
        .output-actions button:hover { background-color: var(--bg-color); color: var(--text-primary); }
        .ai-output-content { font-size: 0.95rem; line-height: 1.6; color: var(--text-secondary); max-height: 150px; overflow-y: auto; }
        .ai-output-content p { margin-bottom: 0.75rem; }
        .ai-output-content ul { list-style-position: inside; margin-left: 0.5rem; margin-bottom: 0.75rem; }
        .ai-output-content li { margin-bottom: 0.25rem; }
        .ai-output-content blockquote { border-left: 3px solid var(--accent-color); padding-left: 1rem; margin-left: 0.5rem; font-style: italic; color: var(--text-primary); }
        
        /* Modal Styles */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        #modal-panel { background-color: var(--editor-bg); border-radius: 1rem; padding: 2rem; width: 90%; max-width: 800px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: scale(0.95); transition: transform 0.3s ease; }
        #modal-overlay:not(.hidden) #modal-panel { transform: scale(1); }
        #modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        #modal-content { flex-grow: 1; overflow-y: auto; line-height: 1.7; }
        #modal-close-btn { padding: 0.5rem; color: var(--text-muted); }
        #modal-close-btn:hover { color: var(--text-primary); }

        /* Loading Indicator */
        .loading-indicator { display: flex; align-items: center; gap: 0.75rem; color: var(--text-secondary); }
        .loading-spinner { border: 2px solid rgba(0,0,0,0.1); border-top: 2px solid var(--text-primary); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Slash Command Menu */
        #slash-command-menu { position: absolute; bottom: 100%; left: 0; width: 100%; background-color: var(--editor-bg); border: 1px solid var(--border-color); border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 100; margin-bottom: 0.5rem; max-height: 200px; overflow-y: auto; }
        .command-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; cursor: pointer; }
        .command-item:hover, .command-item.active { background-color: var(--accent-color-light); }
        .command-item svg { width: 20px; height: 20px; color: var(--text-secondary); }
        .command-item .command-name { font-weight: 500; color: var(--text-primary); }
        .command-item .command-desc { font-size: 0.875rem; color: var(--text-secondary); }

        /* Save Button */
        #save-status { font-size: 0.875rem; color: var(--text-muted); transition: all 0.3s; }

        /* Utility classes */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Editor Panel -->
        <main id="editor-panel">
            <div id="editor-wrapper">
                <div id="editor-column">
                     <div class="flex justify-end items-center mb-6 h-8">
                        <div id="save-status" class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                            <span>Saved</span>
                        </div>
                    </div>
                    <input type="text" id="doc-title" placeholder="Untitled Story">
                    <div id="editor"></div>
                </div>
                <div id="suggestion-toolbar" class="hidden">
                    <button id="suggestion-accept" title="Accept Suggestion">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Accept
                    </button>
                    <button id="suggestion-reject" title="Reject Suggestion">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        Reject
                    </button>
                </div>
            </div>
        </main>

        <!-- AI Side Panel -->
        <aside id="ai-panel">
            <h2 class="text-lg font-bold mb-4">The Creative Crew</h2>
            <div id="tools-grid">
                <!-- Agent buttons will be dynamically generated here -->
            </div>
            
            <div id="selected-text-card" class="ai-output-card hidden">
                <div class="agent-header">
                    <p class="agent-name" style="color: var(--text-secondary);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                        Selected Text
                    </p>
                    <div class="output-actions">
                        <button id="clear-selection-btn" title="Clear Selection">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                </div>
                <div id="selected-text-content" class="ai-output-content"></div>
            </div>

            <div id="ai-output-container">
                <!-- AI output cards will be appended here -->
                <div id="output-placeholder" class="flex flex-col items-center justify-center h-full text-center text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-4"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                    <p class="font-medium">AI responses will appear here.</p>
                    <p class="text-sm">Select an agent and give it a prompt below.</p>
                </div>
            </div>

            <form id="chat-form">
                <div id="chat-form-wrapper">
                    <div id="slash-command-menu" class="hidden"></div>
                    <input type="text" id="chat-input" placeholder="Ask an agent, or type '/' for commands..." autocomplete="off">
                    <button id="send-btn" type="submit" title="Send" disabled>
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                    </button>
                </div>
            </form>
        </aside>
    </div>

    <!-- Modal Structure -->
    <div id="modal-overlay" class="hidden">
        <div id="modal-panel">
            <div id="modal-header">
                <h3 id="modal-title" class="text-lg font-bold agent-name"></h3>
                <button id="modal-close-btn" title="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="modal-content"></div>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // --- Agent Definitions ---
        const agents = {
            "Orchestrator": {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="6" height="6" rx="2"/><rect x="15" y="15" width="6" height="6" rx="2"/><path d="M9 6h6"/><path d="M15 9V6"/><path d="M9 18v-3h6v3"/></svg>`,
                description: "The showrunner. Give a high-level goal and it delegates to the right agent.",
                isOrchestrator: true,
            },
            "Story Writer": {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>`,
                description: "The Narrator. Writes a story or scene based on a prompt.",
                defaultPrompt: "Write a short story about a mysterious traveler arriving in a small, isolated town.",
            },
             "Continuator": {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17a5 5 0 0 0 5-5 5 5 0 0 0-5-5 5 5 0 0 0-5 5c0 2.21.89 4.21 2.34 5.66L12 20l2.66-2.34A4.99 4.99 0 0 0 17 12"/><path d="m12 7-2 2 2 2"/></svg>`,
                description: "Continues writing from the last sentence.",
                context: "full",
                promptTemplate: "You are a master storyteller. Below is a story in progress. Continue writing the story from where it leaves off, adding one or two new paragraphs. Maintain the existing tone, style, and characters. Do not repeat the existing text. Just provide the new paragraphs."
            },
            "Brainstormer": {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 12h.01"/><path d="M17.3 7.7a9 9 0 1 0-10.6 10.6"/><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"/></svg>`,
                description: "The Muse. Generates ideas, themes, and plot twists.",
                defaultPrompt: "Generate 5 character concepts for a space opera.",
            },
            "Character Actor": {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 21a8 8 0 0 0-12 0"/><circle cx="12" cy="11" r="4"/><path d="M12 3a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-1a2 2 0 0 0-2 2v1"/></svg>`,
                description: "Embodies a character, simulating their dialogue and actions.",
                defaultPrompt: "You are a cynical, veteran detective. Write a short, dramatic scene with an idealistic rookie at a grim crime scene.",
            },
            "Stylist": {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>`,
                description: "The Voice Coach. Refines text for style, tone, and impact.",
                context: "selection",
                directEdit: true,
                promptTemplate: "You are a writing stylist. Revise the following text to be more concise and impactful. Output ONLY the revised text, without any extra commentary or quotation marks."
            },
            "Continuity": {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>`,
                description: "The Script Supervisor. Checks for inconsistencies in the plot.",
                context: "full",
                promptTemplate: "As a continuity agent, analyze the following text for inconsistencies, plot holes, or contradictions. List your findings clearly."
            },
            "Audience Sim": {
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
                description: "Virtual Focus Group. Provides feedback from a reader's perspective.",
                context: "selection",
                promptTemplate: "I am a 'Hardcore Fantasy Fan'. Read the following text and provide feedback on pacing, clarity, and emotional impact from my perspective."
            }
        };

        // --- Slash Command Definitions ---
        const slashCommands = {
            "continue": { agent: "Continuator", description: "Continue writing from the last sentence." },
            "improve": { agent: "Stylist", description: "Improve the selected text." },
            "brainstorm": { agent: "Brainstormer", description: "Brainstorm ideas or plot points." },
            "check": { agent: "Continuity", description: "Check the full document for continuity." },
        };

        // --- Quill & Suggestion Blot Setup ---
        let Inline = Quill.import('blots/inline');
        class SuggestionBlot extends Inline {
          static create() { return super.create().setAttribute('class', 'ai-suggestion'), super.create(); }
        }
        SuggestionBlot.blotName = 'suggestion';
        SuggestionBlot.tagName = 'span';
        Quill.register(SuggestionBlot);

        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: { toolbar: false },
            placeholder: 'Start your story here. Use the AI Creative Crew on the right to help you write...'
        });

        // --- Gemini API & Core Logic ---
        const API_KEY = "AIzaSyCYBdYx4vcLbZBXlmJ32EKCCNuKA-TdFoY"; // Test key
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
        const showdownConverter = new showdown.Converter();

        async function callGemini(prompt) {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
            const result = await response.json();
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
                return result.candidates[0].content.parts[0].text;
            }
            if (result.promptFeedback && result.promptFeedback.blockReason) {
                 throw new Error(`Request blocked: ${result.promptFeedback.blockReason}`);
            }
            throw new Error("Unexpected API response structure.");
        }
        
        // --- UI Elements ---
        const docTitle = document.getElementById('doc-title');
        const chatInput = document.getElementById('chat-input');
        const chatForm = document.getElementById('chat-form');
        const sendBtn = document.getElementById('send-btn');
        const toolsGrid = document.getElementById('tools-grid');
        const outputContainer = document.getElementById('ai-output-container');
        const outputPlaceholder = document.getElementById('output-placeholder');
        const suggestionToolbar = document.getElementById('suggestion-toolbar');
        const suggestionAcceptBtn = document.getElementById('suggestion-accept');
        const suggestionRejectBtn = document.getElementById('suggestion-reject');
        const selectedTextCard = document.getElementById('selected-text-card');
        const selectedTextContent = document.getElementById('selected-text-content');
        const clearSelectionBtn = document.getElementById('clear-selection-btn');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const slashCommandMenu = document.getElementById('slash-command-menu');
        const saveStatus = document.getElementById('save-status');

        // --- State Management ---
        let activeAgentName = 'Orchestrator';
        let activeSuggestion = { range: null, originalText: null, blot: null };
        let lastKnownSelection = { range: null, text: '' };
        let isGenerating = false;
        let saveTimeout;

        // --- UI Initialization ---
        function initializeAgents() {
            toolsGrid.innerHTML = '';
            Object.keys(agents).forEach(agentName => {
                const agent = agents[agentName];
                const button = document.createElement('button');
                button.className = 'tool-btn';
                if (agentName === activeAgentName) button.classList.add('active');
                button.dataset.agent = agentName;
                button.title = agent.description;
                button.innerHTML = `${agent.icon}<span>${agentName}</span>`;
                button.addEventListener('click', () => selectAgent(agentName));
                toolsGrid.appendChild(button);
            });
        }

        function selectAgent(agentName) {
            activeAgentName = agentName;
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.agent === agentName);
            });
            const agent = agents[agentName];
            chatInput.placeholder = agent.defaultPrompt || `Ask ${agentName}...`;
            updateSendButtonState();
            if (agent.context) handleAgentAction(agentName);
        }

        function updateSendButtonState() {
            const agent = agents[activeAgentName];
            const canSend = !agent.context && !isGenerating;
            sendBtn.disabled = !canSend;
        }

        // --- Save & Load Logic ---
        function scheduleSave() {
            saveStatus.querySelector('span').textContent = 'Saving...';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveDocument, 1000);
        }

        function saveDocument() {
            const data = {
                title: docTitle.value,
                content: quill.getContents()
            };
            localStorage.setItem('digitalWriterRoomSave', JSON.stringify(data));
            saveStatus.querySelector('span').textContent = 'Saved';
        }

        function loadDocument() {
            const savedData = localStorage.getItem('digitalWriterRoomSave');
            if (savedData) {
                const data = JSON.parse(savedData);
                docTitle.value = data.title || '';
                quill.setContents(data.content);
            }
        }

        // --- UI Interaction Logic ---
        function createOutputCard(agentName, content, isHtml = false) {
            outputPlaceholder.classList.add('hidden');
            const cardId = `card-${Date.now()}`;
            const card = document.createElement('div');
            card.className = 'ai-output-card';
            card.id = cardId;
            const cardContent = isHtml ? content : showdownConverter.makeHtml(content);

            const isSystemMessage = agentName === 'System' || agentName === 'System Error';
            const systemIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`;
            
            let agentHeaderHTML = isSystemMessage ? `
                <div class="agent-header">
                    <p class="agent-name" style="color: ${agentName === 'System Error' ? 'var(--danger-color)' : 'var(--text-secondary)'};">
                        ${systemIcon} ${agentName}
                    </p>
                </div>` : `
                <div class="agent-header">
                    <p class="agent-name">${agents[agentName].icon} ${agentName}</p>
                    <div class="output-actions">
                        <button title="AI Insert" data-action="ai-insert"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg></button>
                        <button title="Insert at Cursor" data-action="insert"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></svg></button>
                        <button title="Copy Text" data-action="copy"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg></button>
                        <button title="Remove" data-action="remove"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                    </div>
                </div>`;

            card.innerHTML = `${agentHeaderHTML}<div class="ai-output-content">${cardContent}</div>`;
            outputContainer.appendChild(card);
            card.scrollIntoView({ behavior: 'smooth', block: 'end' });

            if (!isSystemMessage) {
                card.querySelector('.output-actions').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const action = button.dataset.action;
                    const contentDiv = card.querySelector('.ai-output-content');
                    const text = contentDiv.innerText;
                    
                    if (action === 'ai-insert') {
                        handleAiInsert(text, button);
                    } else if (action === 'insert') {
                        quill.insertText(quill.getSelection(true).index, `\n\n${text}\n\n`, 'user');
                    } else if (action === 'copy') {
                        navigator.clipboard.writeText(text);
                        const originalIcon = button.innerHTML;
                        button.innerHTML = 'Copied!';
                        setTimeout(() => button.innerHTML = originalIcon, 1500);
                    } else if (action === 'remove') {
                        card.remove();
                    }
                });
            }
            return card;
        }

        function showLoading(agentName) {
            const loadingHTML = `<div class="loading-indicator"><div class="loading-spinner"></div><span>${agentName} is thinking...</span></div>`;
            return createOutputCard(agentName, loadingHTML, true);
        }
        
        // --- Suggestion & Selection Toolbar Logic ---
        quill.on('selection-change', (range, oldRange, source) => {
            if (source === 'user') {
                if (range && range.length > 0) {
                    const text = quill.getText(range.index, range.length);
                    lastKnownSelection = { range, text };
                    selectedTextContent.innerText = text;
                    selectedTextCard.classList.remove('hidden');
                } else if (range && range.length === 0) {
                    lastKnownSelection = { range: null, text: '' };
                    selectedTextCard.classList.add('hidden');
                }
            }

            if (range && range.length === 0) {
                const [blot, offset] = quill.getLeaf(range.index);
                if (blot && blot.statics.blotName === 'suggestion') {
                    const blotBounds = quill.getBounds(range.index, 0);
                    suggestionToolbar.style.top = `${blotBounds.top - suggestionToolbar.offsetHeight - 8}px`;
                    suggestionToolbar.style.left = `${blotBounds.left}px`;
                    suggestionToolbar.classList.remove('hidden');
                    activeSuggestion.blot = blot;
                } else {
                    suggestionToolbar.classList.add('hidden');
                }
            } else {
                suggestionToolbar.classList.add('hidden');
            }
        });

        clearSelectionBtn.addEventListener('click', () => {
            lastKnownSelection = { range: null, text: '' };
            selectedTextCard.classList.add('hidden');
            quill.setSelection(null);
        });

        suggestionAcceptBtn.addEventListener('click', () => {
            if (activeSuggestion.blot) {
                const offset = activeSuggestion.blot.offset(quill.scroll);
                const length = activeSuggestion.blot.length();
                quill.formatText(offset, length, 'suggestion', false, 'user');
                suggestionToolbar.classList.add('hidden');
                activeSuggestion = {};
            }
        });
        
        suggestionRejectBtn.addEventListener('click', () => {
            if (activeSuggestion.blot && activeSuggestion.originalText) {
                const offset = activeSuggestion.blot.offset(quill.scroll);
                const length = activeSuggestion.blot.length();
                quill.deleteText(offset, length, 'user');
                quill.insertText(offset, activeSuggestion.originalText, 'user');
                suggestionToolbar.classList.add('hidden');
                activeSuggestion = {};
            }
        });

        // --- Main Agent Logic ---
        async function handleAgentAction(agentName, userInput = '') {
            const agent = agents[agentName];
            let prompt;
            let selectionRange, originalText;
            
            const fullDocumentText = quill.getText();

            if (agent.context) {
                if (agent.context === 'selection' && lastKnownSelection.range && lastKnownSelection.range.length > 0) {
                    selectionRange = lastKnownSelection.range;
                    originalText = lastKnownSelection.text;
                } else {
                    originalText = fullDocumentText;
                    selectionRange = { index: 0, length: originalText.length };
                }
                if (!originalText.trim()) {
                    createOutputCard('System', `<p>The document is empty. The <strong>${agentName}</strong> agent needs some content to work with.</p>`, true);
                    return;
                }
                prompt = `${agent.promptTemplate}\n\n---\n\n${originalText}`;
            } else {
                prompt = userInput || agent.defaultPrompt;
                if (fullDocumentText.trim().length > 50) { // Add context if doc is substantial
                    prompt = `Given the story so far:\n\n---\n${fullDocumentText}\n---\n\nNow, please follow this instruction: ${prompt}`;
                }
            }

            isGenerating = true;
            if (agent.context && lastKnownSelection.range) selectedTextCard.classList.add('is-processing');
            updateSendButtonState();
            chatInput.disabled = true;
            const loadingCard = showLoading(agentName);

            try {
                const response = await callGemini(prompt);
                loadingCard.remove();

                if (agent.directEdit && selectionRange) {
                    quill.deleteText(selectionRange.index, selectionRange.length, 'user');
                    activeSuggestion.originalText = originalText;
                    quill.insertText(selectionRange.index, response, 'user');
                    quill.formatText(selectionRange.index, response.length, 'suggestion', true, 'user');
                    quill.setSelection(selectionRange.index, response.length, 'user');
                } else if (agentName === 'Continuator') {
                    const lastIndex = quill.getLength();
                    quill.insertText(lastIndex, `\n\n${response}`, 'user');
                } else {
                    createOutputCard(agentName, response);
                }
            } catch (error) {
                loadingCard.remove();
                createOutputCard('System Error', `<strong class="text-red-500">Error:</strong> ${error.message}`, true);
            } finally {
                isGenerating = false;
                if (agent.context) selectedTextCard.classList.remove('is-processing');
                chatInput.disabled = false;
                updateSendButtonState();
                chatInput.focus();
            }
        }

        async function handleAiInsert(textToInsert, button) {
            const originalIcon = button.innerHTML;
            button.innerHTML = `<div class="loading-spinner" style="width: 16px; height: 16px;"></div>`;
            button.disabled = true;

            const fullDocumentText = quill.getText();
            const prompt = `You are an expert editor. Your task is to intelligently insert a new piece of text into an existing document.
Analyze the document and the text to be inserted. Determine the best character index for the insertion.
The goal is to place the new text where it makes the most sense contextually and grammatically.

DOCUMENT:
---
${fullDocumentText}
---

TEXT TO INSERT:
---
${textToInsert}
---

Respond with ONLY a JSON object containing the character index where the new text should be inserted. For example: {"index": 450}.
The index should be where the new text begins. Do not add any other text or explanation.`;

            try {
                let responseText = await callGemini(prompt);
                responseText = responseText.replace(/```json/g, '').replace(/```/g, '').trim();
                const { index } = JSON.parse(responseText);

                if (typeof index === 'number' && index >= 0 && index <= fullDocumentText.length) {
                    quill.insertText(index, `\n\n${textToInsert}\n\n`, 'user');
                    quill.setSelection(index, textToInsert.length);
                    quill.scrollIntoView();
                } else {
                    throw new Error("Invalid index received from AI.");
                }
            } catch (error) {
                createOutputCard('System Error', `AI Insert failed: ${error.message}. Inserting at cursor instead.`, true);
                quill.insertText(quill.getSelection(true).index, `\n\n${textToInsert}\n\n`, 'user');
            } finally {
                button.innerHTML = originalIcon;
                button.disabled = false;
            }
        }
        
        // --- Chat & Slash Command Logic ---
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if (!userInput || isGenerating) return;
            
            if (activeAgentName === 'Orchestrator') {
                runOrchestrator(userInput);
            } else {
                handleAgentAction(activeAgentName, userInput);
            }
            chatInput.value = '';
        });

        async function runOrchestrator(userInput) {
            const orchestrationPrompt = `You are an orchestrator for a multi-agent writing assistant. Analyze the user's request and determine which agent should handle it and what the specific prompt for that agent should be. The available agents are: [${Object.keys(agents).filter(a => a !== 'Orchestrator').join(', ')}]. Respond with ONLY a JSON object in the format: {"agent": "AGENT_NAME", "prompt": "prompt_for_the_agent"}. User request: "${userInput}"`;
            
            isGenerating = true;
            updateSendButtonState();
            chatInput.disabled = true;
            const loadingCard = showLoading('Orchestrator');
            
            try {
                let orchestratorResponseText = await callGemini(orchestrationPrompt);
                orchestratorResponseText = orchestratorResponseText.replace(/```json/g, '').replace(/```/g, '').trim();
                const { agent: specialistAgent, prompt: specialistPrompt } = JSON.parse(orchestratorResponseText);
                
                loadingCard.remove();
                const delegationCard = createOutputCard('System', `Passing task to <strong>${specialistAgent}</strong>...`, true);
                
                selectAgent(specialistAgent);
                await handleAgentAction(specialistAgent, specialistPrompt);
                delegationCard.remove();


            } catch (error) {
                loadingCard.remove();
                createOutputCard('System Error', `<strong class="text-red-500">Orchestration Error:</strong> ${error.message}. Trying a different agent.`, true);
                handleAgentAction('Story Writer', userInput); // Fallback
            } finally {
                selectAgent('Orchestrator');
                isGenerating = false;
                updateSendButtonState();
                chatInput.disabled = false;
                chatInput.focus();
            }
        }

        chatInput.addEventListener('input', () => {
            const value = chatInput.value;
            if (value.startsWith('/')) {
                showSlashCommands(value.substring(1));
            } else {
                hideSlashCommands();
            }
        });

        function showSlashCommands(filter) {
            slashCommandMenu.innerHTML = '';
            const filteredCommands = Object.keys(slashCommands).filter(cmd => cmd.includes(filter.toLowerCase()));
            
            if (filteredCommands.length === 0) {
                hideSlashCommands();
                return;
            }

            filteredCommands.forEach((cmdKey, index) => {
                const command = slashCommands[cmdKey];
                const agent = agents[command.agent];
                const item = document.createElement('div');
                item.className = 'command-item';
                if (index === 0) item.classList.add('active');
                item.innerHTML = `
                    ${agent.icon}
                    <div>
                        <div class="command-name">/${cmdKey}</div>
                        <div class="command-desc">${command.description}</div>
                    </div>`;
                item.addEventListener('click', () => executeSlashCommand(cmdKey));
                slashCommandMenu.appendChild(item);
            });
            slashCommandMenu.classList.remove('hidden');
        }

        function hideSlashCommands() {
            slashCommandMenu.classList.add('hidden');
        }

        function executeSlashCommand(cmdKey) {
            const command = slashCommands[cmdKey];
            hideSlashCommands();
            chatInput.value = '';
            selectAgent(command.agent);
        }

        // --- Modal Logic ---
        function closeModal() { modalOverlay.classList.add('hidden'); }
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
        modalCloseBtn.addEventListener('click', closeModal);

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAgents();
            loadDocument();
            selectAgent('Orchestrator');
            quill.focus();
            quill.on('text-change', scheduleSave);
            docTitle.addEventListener('input', scheduleSave);
        });
    </script>
</body>
</html>
